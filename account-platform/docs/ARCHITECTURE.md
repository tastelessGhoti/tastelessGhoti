# 아키텍처 문서

## 시스템 개요

Account Platform은 대용량 트래픽을 처리하는 회원 계정 플랫폼입니다. 모든 서비스에서 필요로 하는 회원 정보, 인증 토큰, 약관 동의, KYC 인증 기능을 중앙에서 관리합니다.

## 계층 구조

```
┌─────────────────────────────────────────────────────┐
│                   Presentation Layer                 │
│              (Controller, DTO, Validation)           │
├─────────────────────────────────────────────────────┤
│                   Application Layer                  │
│                      (Service)                       │
├─────────────────────────────────────────────────────┤
│                    Domain Layer                      │
│                (Entity, Repository)                  │
├─────────────────────────────────────────────────────┤
│                Infrastructure Layer                  │
│             (Redis, External Services)               │
└─────────────────────────────────────────────────────┘
```

## 도메인 설계

### Member (회원)
회원의 기본 정보와 상태를 관리합니다.

**상태 전이**
```
                  ┌──────────┐
                  │  ACTIVE  │
                  └────┬─────┘
                       │
         ┌─────────────┼─────────────┐
         ▼             │             ▼
   ┌──────────┐        │      ┌───────────┐
   │ DORMANT  │        │      │ SUSPENDED │
   └────┬─────┘        │      └─────┬─────┘
        │              │            │
        └──────────────┴────────────┘
                       │
                       ▼
               ┌───────────┐
               │ WITHDRAWN │
               └───────────┘
```

### Auth (인증)
JWT 기반 토큰 발급 및 관리를 담당합니다.

**토큰 흐름**
```
1. 로그인 요청
   └─> CI 기반 회원 조회
   └─> 로그인 시도 횟수 검증
   └─> 회원 상태 검증
   └─> Access Token + Refresh Token 발급
   └─> Refresh Token Redis 저장

2. 토큰 갱신
   └─> Refresh Token 검증
   └─> Redis 저장 토큰과 비교
   └─> 새 토큰 쌍 발급
   └─> 기존 Refresh Token 삭제

3. 로그아웃
   └─> Access Token 블랙리스트 등록
   └─> Refresh Token 삭제
```

### Terms (약관)
약관 버전 관리와 회원별 동의 이력을 관리합니다.

**핵심 규칙**
- 필수 약관은 동의 철회 불가
- 약관 버전 변경 시 기존 동의는 유효
- 새 버전 약관은 별도 동의 필요

### KYC (본인확인)
자금세탁방지를 위한 고객확인 절차를 관리합니다.

**인증 레벨별 한도**
| 레벨 | 1일 한도 | 월 한도 |
|------|----------|---------|
| NONE | 0원 | 0원 |
| LEVEL_1 | 50만원 | 300만원 |
| LEVEL_2 | 200만원 | 1,000만원 |
| LEVEL_3 | 500만원 | 5,000만원 |

## 데이터 저장소 전략

### MySQL
- 회원 정보, 로그인 이력, 약관, KYC 정보
- InnoDB 엔진 사용
- 적절한 인덱스 설계로 조회 성능 확보

### Redis
- Refresh Token 저장 (TTL 7일)
- 토큰 블랙리스트 (TTL = 토큰 남은 유효시간)
- 향후 캐싱 레이어로 확장 가능

## API 설계 원칙

### 응답 형식
```json
{
  "code": "SUCCESS",
  "message": null,
  "data": { ... }
}
```

### 에러 응답
```json
{
  "code": "M001",
  "message": "회원을 찾을 수 없습니다",
  "data": null
}
```

### API 버전 관리
- URL Path 방식: `/api/v1/...`
- 하위 호환성 유지 원칙

## 보안 고려사항

### 개인정보 보호
- API 응답 시 민감정보 마스킹 (이름, 전화번호, 이메일)
- 내부 서비스 전용 API 분리 (`/internal/api/...`)
- 신분증 번호는 해시 처리 후 저장

### 인증 보안
- 로그인 시도 횟수 제한 (30분 내 5회)
- Refresh Token Rotation 적용
- 로그아웃 시 토큰 즉시 무효화

### 로깅
- 민감정보 로깅 금지
- CI는 일부 마스킹 후 로깅

## 확장 계획

### 단기
- 캐시 레이어 추가 (회원 정보 캐싱)
- 분산 락 적용 (동시성 제어 강화)

### 중기
- 이벤트 기반 아키텍처 도입 (회원 상태 변경 이벤트)
- 멀티 모듈 구조 전환

### 장기
- Spring WebFlux 마이그레이션
- gRPC 도입 (내부 서비스 통신)
